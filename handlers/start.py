# handlers/start.py
from aiogram import Router, Bot
from aiogram.filters import CommandStart
from aiogram.types import Message, ChatMemberAdministrator, ChatMemberOwner
from database.queries import add_user
from logger import logger

start_r = Router()


async def check_bot_admin(bot: Bot, chat_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –±–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤ —á–∞—Ç–µ."""
    try:
        bot_member = await bot.get_chat_member(chat_id=chat_id, user_id=bot.id)
        return isinstance(bot_member, (ChatMemberAdministrator, ChatMemberOwner))
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —á–∞—Ç–µ {chat_id}: {e}")
        return False


# @start_r.message(CommandStart())
# async def start(message: Message):
#     """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è –≤ –õ–°."""
#     from_user = message.from_user
#     chat_id = message.chat.id
#
#     if not from_user:
#         await message.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.")
#         return
#
#     # –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
#     if message.chat.type == "private":
#         await message.answer(
#             "–ü—Ä–∏–≤–µ—Ç! –Ø –ë–æ—Ç –ë—É–ª–æ—á–∫–∞ –î–Ω—è! ü•êü§ñ\n\n"
#             "–ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–∏–Ω–æ—Å–∏—Ç—å —Ä–∞–¥–æ—Å—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã! –Ø –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å—Ç–∏–∫–µ—Ä–∞–º–∏, "
#             "–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤—ã–±–∏—Ä–∞—é —Å–∞–º—É—é –∞–ø–ø–µ—Ç–∏—Ç–Ω—É—é –±—É–ª–æ—á–∫—É —Å—Ä–µ–¥–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ —Ä–∞–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –≤–∫—É—Å–Ω–æ—Å—Ç–∏. üç©‚ú®\n\n"
#             "–î–æ–±–∞–≤—å –º–µ–Ω—è –≤ —Å–≤–æ–π —á–∞—Ç, —Å–¥–µ–ª–∞–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π –∫–æ–º–∞–Ω–¥–æ–π /start. "
#             "–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–π /play, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É! üéÆ\n\n"
#             "<i>–°–æ–∑–¥–∞–Ω –¥–ª—è –≤–µ—Å–µ–ª—å—è –∏ –±—É–ª–æ—á–µ–∫.</i>\n"
#             "<i>–ü—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –ø–æ –º–µ—Ä–µ —Ç–æ–≥–æ, –∫–∞–∫ –µ–≥–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –ø—Ä–æ–∫–∞—á–∏–≤–∞–µ—Ç —Å–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç (–∞ –ø–æ–∫–∞ –æ–Ω –µ—Å—Ç –±—É–ª–æ—á–∫–∏ –∏ –ø–∏—à–µ—Ç –∫–æ–¥). üßêüç©</i>",
#             parse_mode="HTML",
#         )
#         return
#
#     if not await check_bot_admin(message.bot, chat_id):
#         await message.reply(
#             "–Ø –Ω–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É, –ø–æ–∫–∞ –Ω–µ —Å—Ç–∞–Ω—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º! üòî\n"
#             "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–¥–µ–ª–∞–π –º–µ–Ω—è –∞–¥–º–∏–Ω–æ–º –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –∏ —è –Ω–∞—á–Ω—É —Ä–∞–∑–¥–∞–≤–∞—Ç—å –±—É–ª–æ—á–∫–∏! ü•ê",
#             parse_mode="HTML",
#         )
#         logger.warning(
#             f"–ë–æ—Ç –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ —á–∞—Ç–µ {chat_id}: –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
#         )
#         return
#     # –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –±–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
#     bot_member = await message.bot.get_chat_member(
#         chat_id=chat_id, user_id=message.bot.id
#     )
#     is_admin = isinstance(bot_member, (ChatMemberAdministrator, ChatMemberOwner))
#
#     if not is_admin:
#         await message.reply(
#             "–Ø –Ω–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É, –ø–æ–∫–∞ –Ω–µ —Å—Ç–∞–Ω—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º! üòî\n"
#             "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–¥–µ–ª–∞–π –º–µ–Ω—è –∞–¥–º–∏–Ω–æ–º –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –∏ —è –Ω–∞—á–Ω—É —Ä–∞–∑–¥–∞–≤–∞—Ç—å –±—É–ª–æ—á–∫–∏! ü•ê",
#             parse_mode="HTML",
#         )
#         logger.warning(
#             f"–ë–æ—Ç –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ —á–∞—Ç–µ {chat_id}: –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
#         )
#         return
#
#     # –ë–æ—Ç ‚Äî –∞–¥–º–∏–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É
#     user = await add_user(
#         telegram_id=from_user.id,
#         username=from_user.username,
#         full_name=from_user.full_name,
#         chat_id=chat_id,
#     )
#
#     display_name = (
#         f"@{from_user.username}" if from_user.username else from_user.full_name
#     )
#     if user:
#         await message.reply(
#             f"–ü—Ä–∏–≤–µ—Ç, {display_name}! –Ø –ë–æ—Ç –ë—É–ª–æ—á–∫–∞ –î–Ω—è, –∏ —è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! ü•ê‚ú®\n"
#             "–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –≤—Å—Ç—Ä–µ—á–∞—Ç—å –Ω–æ–≤–∏—á–∫–æ–≤ —Å—Ç–∏–∫–µ—Ä–∞–º–∏ –∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤—ã–±–∏—Ä–∞—Ç—å —Å–∞–º—É—é –≤–∫—É—Å–Ω—É—é –±—É–ª–æ—á–∫—É. "
#             "–ò—Å–ø–æ–ª—å–∑—É–π /play, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ –∏ –Ω–∞—á–∞—Ç—å –ø–æ–ª—É—á–∞—Ç—å –±—É–ª–æ—á–∫–∏! üéÆ",
#             parse_mode="HTML",
#         )
#         logger.info(f"–ë–æ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ —á–∞—Ç–µ {chat_id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {from_user.id}")
#     else:
#         await message.reply(
#             f"–ü—Ä–∏–≤–µ—Ç, {display_name}! –Ø —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ —ç—Ç–æ–º —á–∞—Ç–µ! ü•ê\n"
#             "–ò—Å–ø–æ–ª—å–∑—É–π /play, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –∏ –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ—é –±—É–ª–æ—á–∫—É! üéÆ",
#             parse_mode="HTML",
#         )
#         logger.debug(
#             f"–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤ —á–∞—Ç–µ {chat_id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {from_user.id}"
#         )
@start_r.message(CommandStart())
async def start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è –≤ –õ–°."""
    from_user = message.from_user
    chat_id = message.chat.id

    if not from_user:
        await message.reply("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.")
        return

    if message.chat.type == "private":
        await message.answer(
            "–ü—Ä–∏–≤–µ—Ç! –Ø –ë–æ—Ç –ë—É–ª–æ—á–∫–∞ –î–Ω—è! ü•êü§ñ\n\n"
            "–ú–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–∏–Ω–æ—Å–∏—Ç—å —Ä–∞–¥–æ—Å—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã! –Ø –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å—Ç–∏–∫–µ—Ä–∞–º–∏, "
            "–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤—ã–±–∏—Ä–∞—é —Å–∞–º—É—é –∞–ø–ø–µ—Ç–∏—Ç–Ω—É—é –±—É–ª–æ—á–∫—É —Å—Ä–µ–¥–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ —Ä–∞–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –≤–∫—É—Å–Ω–æ—Å—Ç–∏. üç©‚ú®\n\n"
            "–î–æ–±–∞–≤—å –º–µ–Ω—è –≤ —Å–≤–æ–π —á–∞—Ç, —Å–¥–µ–ª–∞–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π –∫–æ–º–∞–Ω–¥–æ–π /start. "
            "–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–π /play, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É! üéÆ\n\n"
            "<i>–°–æ–∑–¥–∞–Ω –¥–ª—è –≤–µ—Å–µ–ª—å—è –∏ –±—É–ª–æ—á–µ–∫.</i>\n"
            "<i>–ü—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –ø–æ –º–µ—Ä–µ —Ç–æ–≥–æ, –∫–∞–∫ –µ–≥–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –ø—Ä–æ–∫–∞—á–∏–≤–∞–µ—Ç —Å–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç (–∞ –ø–æ–∫–∞ –æ–Ω –µ—Å—Ç –±—É–ª–æ—á–∫–∏ –∏ –ø–∏—à–µ—Ç –∫–æ–¥). üßêüç©</i>",
            parse_mode="HTML",
        )
        return

    if not await check_bot_admin(message.bot, chat_id):
        await message.reply(
            "–Ø –Ω–µ –º–æ–≥—É –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É, –ø–æ–∫–∞ –Ω–µ —Å—Ç–∞–Ω—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º! üòî\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–¥–µ–ª–∞–π –º–µ–Ω—è –∞–¥–º–∏–Ω–æ–º –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –∏ —è –Ω–∞—á–Ω—É —Ä–∞–∑–¥–∞–≤–∞—Ç—å –±—É–ª–æ—á–∫–∏! ü•ê",
            parse_mode="HTML",
        )
        logger.warning(
            f"–ë–æ—Ç –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ —á–∞—Ç–µ {chat_id}: –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
        )
        return

    user = await add_user(
        telegram_id=from_user.id,
        username=from_user.username,
        full_name=from_user.full_name,
        chat_id=chat_id,
    )

    display_name = (
        f"@{from_user.username}" if from_user.username else from_user.full_name
    )
    if user:
        await message.reply(
            f"–ü—Ä–∏–≤–µ—Ç, {display_name}! –Ø –ë–æ—Ç –ë—É–ª–æ—á–∫–∞ –î–Ω—è, –∏ —è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! ü•ê‚ú®\n"
            "–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –≤—Å—Ç—Ä–µ—á–∞—Ç—å –Ω–æ–≤–∏—á–∫–æ–≤ —Å—Ç–∏–∫–µ—Ä–∞–º–∏ –∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤—ã–±–∏—Ä–∞—Ç—å —Å–∞–º—É—é –≤–∫—É—Å–Ω—É—é –±—É–ª–æ—á–∫—É. "
            "–ò—Å–ø–æ–ª—å–∑—É–π /play, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ –∏ –Ω–∞—á–∞—Ç—å –ø–æ–ª—É—á–∞—Ç—å –±—É–ª–æ—á–∫–∏! üéÆ",
            parse_mode="HTML",
        )
        logger.info(f"–ë–æ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ —á–∞—Ç–µ {chat_id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {from_user.id}")
    else:
        await message.reply(
            f"–ü—Ä–∏–≤–µ—Ç, {display_name}! –Ø —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ —ç—Ç–æ–º —á–∞—Ç–µ! ü•ê\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π /play, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –∏ –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ—é –±—É–ª–æ—á–∫—É! üéÆ",
            parse_mode="HTML",
        )
        logger.debug(
            f"–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤ —á–∞—Ç–µ {chat_id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {from_user.id}"
        )
